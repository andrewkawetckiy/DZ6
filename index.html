<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>AR Scene Measurement</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar@1.8.0/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden">
  <a-scene embedded arjs>
    <!-- –ú–∞—Ä–∫–µ—Ä–∏ -->
    <a-marker id="a" type="pattern" preset="custom" url="a.patt">
      <a-sphere color="red" radius="0.02"></a-sphere>
    </a-marker>
    <a-marker id="b" type="pattern" preset="custom" url="b.patt">
      <a-sphere color="blue" radius="0.02"></a-sphere>
    </a-marker>
    <a-marker id="c" type="pattern" preset="custom" url="c.patt">
      <a-sphere color="green" radius="0.02"></a-sphere>
    </a-marker>
    <a-marker id="d" type="pattern" preset="custom" url="d.patt">
      <a-sphere color="yellow" radius="0.02"></a-sphere>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <div style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;">
    <button id="start-btn">–ü–æ—á–∏–Ω–∞—î–º–æ</button>
    <button id="compute-btn" disabled>–û–±—á–∏—Å–ª–∏—Ç–∏</button>
    <div id="info">
      <p id="perimeter"></p>
      <p id="abc"></p>
      <p id="acd"></p>
      <p id="bcd"></p>
      <p id="abd"></p>
    </div>
  </div>

  <script>
    const markers = {
      a: document.querySelector('#a'),
      b: document.querySelector('#b'),
      c: document.querySelector('#c'),
      d: document.querySelector('#d')
    };

    const infoEls = {
      perimeter: document.getElementById('perimeter'),
      abc: document.getElementById('abc'),
      acd: document.getElementById('acd'),
      bcd: document.getElementById('bcd'),
      abd: document.getElementById('abd')
    };

    let log = [];
    const logEvent = msg => {
      const timestamp = new Date().toLocaleTimeString();
      log.push(`[${timestamp}] ${msg}`);
    };

    const distance = (v1, v2) => v1.distanceTo(v2);

    const triangleArea = (a, b, c) => {
      const s = (a + b + c) / 2;
      return Math.sqrt(s * (s - a) * (s - b) * (s - c));
    };

    function drawLine(id, start, end) {
      let line = document.querySelector(`#${id}`);
      if (!line) {
        line = document.createElement('a-entity');
        line.setAttribute('id', id);
        line.setAttribute('line', {
          start: '0 0 0',
          end: '0 0 0',
          color: '#FFD700'
        });
        document.querySelector('a-scene').appendChild(line);
      }
      line.setAttribute('line', {
        start: `${start.x} ${start.y} ${start.z}`,
        end: `${end.x} ${end.y} ${end.z}`,
        color: '#FFD700'
      });
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    let tracking = false;

    document.getElementById('start-btn').addEventListener('click', () => {
      tracking = true;
      log = [];
      logEvent('üîç –ü–æ—á–∞—Ç–æ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤');
    });

    setInterval(() => {
      if (!tracking) return;
      const visible = Object.values(markers).every(marker => marker.object3D.visible);
      document.getElementById('compute-btn').disabled = !visible;
      if (visible) logEvent('‚úÖ –£—Å—ñ –º–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∏–º—ñ');
    }, 1000);

    document.getElementById('compute-btn').addEventListener('click', () => {
      logEvent('üìê –û–±—á–∏—Å–ª–µ–Ω–Ω—è...');

      const pos = {};
      for (let key in markers) {
        pos[key] = markers[key].object3D.getWorldPosition(new THREE.Vector3());
      }

      const ab = distance(pos.a, pos.b);
      const bc = distance(pos.b, pos.c);
      const cd = distance(pos.c, pos.d);
      const da = distance(pos.d, pos.a);
      const ac = distance(pos.a, pos.c);
      const bd = distance(pos.b, pos.d);

      const perimeter = ab + bc + cd + da;
      const areaABC = triangleArea(ab, bc, ac);
      const areaACD = triangleArea(ac, cd, da);
      const areaBCD = triangleArea(bc, cd, bd);
      const areaABD = triangleArea(ab, bd, da);

      infoEls.perimeter.textContent = `–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)}`;
      infoEls.abc.textContent = `–ü–ª–æ—â–∞ ABC: ${areaABC.toFixed(2)}`;
      infoEls.acd.textContent = `–ü–ª–æ—â–∞ ACD: ${areaACD.toFixed(2)}`;
      infoEls.bcd.textContent = `–ü–ª–æ—â–∞ BCD: ${areaBCD.toFixed(2)}`;
      infoEls.abd.textContent = `–ü–ª–æ—â–∞ ABD: ${areaABD.toFixed(2)}`;

      drawLine('ab-line', pos.a, pos.b);
      drawLine('bc-line', pos.b, pos.c);
      drawLine('cd-line', pos.c, pos.d);
      drawLine('da-line', pos.d, pos.a);

      const result = `
–ß–∞—Å: ${new Date().toLocaleString()}
–°—Ç–æ—Ä–æ–Ω–∏:
AB: ${ab.toFixed(2)}
BC: ${bc.toFixed(2)}
CD: ${cd.toFixed(2)}
DA: ${da.toFixed(2)}
AC (–¥—ñ–∞–≥–æ–Ω–∞–ª—å): ${ac.toFixed(2)}
BD (–¥—ñ–∞–≥–æ–Ω–∞–ª—å): ${bd.toFixed(2)}

–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)}
–ü–ª–æ—â—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—ñ–≤:
ABC: ${areaABC.toFixed(2)}
ACD: ${areaACD.toFixed(2)}
BCD: ${areaBCD.toFixed(2)}
ABD: ${areaABD.toFixed(2)}
`;

      downloadFile('results.txt', result);
      downloadFile('log.txt', log.join('\n'));
    });
  </script>
</body>
</html>
