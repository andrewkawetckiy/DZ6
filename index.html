<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR.js – Лінія між маркерами Hiro та Kanji</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene embedded arjs>
      <!-- Камера -->
      <a-camera-static></a-camera-static>

      <!-- Маркер HIRO -->
      <a-marker type="pattern" preset="hiro" id="marker-hiro">
        <a-box color="red" depth="0.1" height="0.1" width="0.1"></a-box>
      </a-marker>

      <!-- Маркер KANJI -->
      <a-marker type="pattern" preset="kanji" id="marker-kanji">
        <a-sphere color="blue" radius="0.05"></a-sphere>
      </a-marker>

      <!-- Лінія -->
      <a-entity id="connecting-line" geometry="primitive: cylinder; radius: 0.01; height: 1"
                material="color: green" visible="false">
      </a-entity>

      <!-- Текст відстані -->
      <a-entity id="distance-label"
                text="value: ; align: center; color: black"
                position="0 0 0"
                visible="false">
      </a-entity>
    </a-scene>

    <script>
      const markerHiro = document.querySelector("#marker-hiro");
      const markerKanji = document.querySelector("#marker-kanji");
      const line = document.querySelector("#connecting-line");
      const label = document.querySelector("#distance-label");

      let visibleHiro = false;
      let visibleKanji = false;

      markerHiro.addEventListener("markerFound", () => { visibleHiro = true; });
      markerHiro.addEventListener("markerLost", () => { visibleHiro = false; });

      markerKanji.addEventListener("markerFound", () => { visibleKanji = true; });
      markerKanji.addEventListener("markerLost", () => { visibleKanji = false; });

      AFRAME.scenes[0].addEventListener("renderstart", () => {
        AFRAME.scenes[0].renderer.setAnimationLoop(() => {
          if (visibleHiro && visibleKanji) {
            const posHiro = markerHiro.object3D.position;
            const posKanji = markerKanji.object3D.position;

            const midpoint = new THREE.Vector3().addVectors(posHiro, posKanji).multiplyScalar(0.5);
            const distance = posHiro.distanceTo(posKanji);

            // Оновлення лінії
            line.setAttribute("position", midpoint);
            line.setAttribute("visible", true);
            line.setAttribute("geometry", {
              primitive: "cylinder",
              radius: 0.01,
              height: distance
            });

            // Обертання лінії
            const diff = new THREE.Vector3().subVectors(posKanji, posHiro);
            const axis = new THREE.Vector3(0, 1, 0);
            const quaternion = new THREE.Quaternion().setFromUnitVectors(axis.clone().normalize(), diff.clone().normalize());
            line.object3D.setRotationFromQuaternion(quaternion);

            // Оновлення тексту
            label.setAttribute("position", midpoint.clone().add(new THREE.Vector3(0, 0.1, 0)));
            label.setAttribute("text", `value: Відстань: ${distance.toFixed(2)} м`);
            label.setAttribute("visible", true);
          } else {
            line.setAttribute("visible", false);
            label.setAttribute("visible", false);
          }
        });
      });
    </script>
  </body>
</html>
