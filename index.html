<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MindAR ‚Äì 2 –º–∞—Ä–∫–µ—Ä–∏ + –ª—ñ–Ω—ñ—è + —Å—Ç–∞—Ç—É—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-aframe.prod.js"></script>
  <style>
    #marker-status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
      z-index: 10;
    }
    #distance-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
      z-index: 10;
    }
  </style>
</head>
<body>
  <!-- üìç –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –≤–∏–¥–∏–º–æ—Å—Ç—ñ –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
  <div id="marker-status">
    <div id="status-a">üî¥ –ú–∞—Ä–∫–µ—Ä A: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div id="status-b">üî¥ –ú–∞—Ä–∫–µ—Ä B: –Ω–µ –≤–∏–¥–Ω–æ</div>
  </div>

  <!-- üìè –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ -->
  <div id="distance-label">–í—ñ–¥—Å—Ç–∞–Ω—å: ---</div>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- üéØ –ú–∞—Ä–∫–µ—Ä–∏ -->
    <a-entity id="marker-a" mindar-image-target="targetIndex: 0">
      <a-sphere color="red" radius="0.2"></a-sphere>
    </a-entity>

    <a-entity id="marker-b" mindar-image-target="targetIndex: 1">
      <a-box color="blue" depth="0.2" height="0.2" width="0.2"></a-box>
    </a-entity>

    <!-- üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ª—ñ–Ω—ñ—ó —Ç–∞ –ª–æ–≥—ñ–∫–∏ -->
    <a-entity marker-logic></a-entity>
  </a-scene>

  <script>
    function createLine() {
      const line = document.createElement('a-cylinder');
      line.setAttribute('radius', '0.01');
      line.setAttribute('color', 'green');
      line.setAttribute('visible', false);
      document.querySelector('a-scene').appendChild(line);
      return line;
    }

    function updateLine(line, markerA, markerB) {
      const posA = markerA.object3D.getWorldPosition(new THREE.Vector3());
      const posB = markerB.object3D.getWorldPosition(new THREE.Vector3());
      const mid = new THREE.Vector3().addVectors(posA, posB).multiplyScalar(0.5);
      const dist = posA.distanceTo(posB);

      line.setAttribute('position', `${mid.x} ${mid.y} ${mid.z}`);
      line.setAttribute('height', dist);
      line.object3D.lookAt(posB);
      line.object3D.rotation.x += Math.PI / 2;

      // –í–∏–≤—ñ–¥ –≤—ñ–¥—Å—Ç–∞–Ω—ñ
      document.getElementById('distance-label').textContent = `–í—ñ–¥—Å—Ç–∞–Ω—å: ${dist.toFixed(2)} –º`;
    }

    AFRAME.registerComponent('marker-logic', {
      init: function () {
        const markerA = document.getElementById('marker-a');
        const markerB = document.getElementById('marker-b');
        const statusA = document.getElementById('status-a');
        const statusB = document.getElementById('status-b');
        const distanceLabel = document.getElementById('distance-label');

        let visibleA = false;
        let visibleB = false;
        const line = createLine();

        markerA.addEventListener('targetFound', () => {
          visibleA = true;
          statusA.textContent = 'üü¢ –ú–∞—Ä–∫–µ—Ä A: –≤–∏–¥–Ω–æ';
        });

        markerA.addEventListener('targetLost', () => {
          visibleA = false;
          statusA.textContent = 'üî¥ –ú–∞—Ä–∫–µ—Ä A: –Ω–µ –≤–∏–¥–Ω–æ';
        });

        markerB.addEventListener('targetFound', () => {
          visibleB = true;
          statusB.textContent = 'üü¢ –ú–∞—Ä–∫–µ—Ä B: –≤–∏–¥–Ω–æ';
        });

        markerB.addEventListener('targetLost', () => {
          visibleB = false;
          statusB.textContent = 'üî¥ –ú–∞—Ä–∫–µ—Ä B: –Ω–µ –≤–∏–¥–Ω–æ';
        });

        this.el.sceneEl.addEventListener('renderstart', () => {
          this.el.sceneEl.renderer.setAnimationLoop(() => {
            if (visibleA && visibleB) {
              updateLine(line, markerA, markerB);
              line.setAttribute('visible', true);
            } else {
              line.setAttribute('visible', false);
              distanceLabel.textContent = '–í—ñ–¥—Å—Ç–∞–Ω—å: ---';
            }
          });
        });
      }
    });
  </script>
</body>
</html>
