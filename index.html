<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR –ß–æ—Ç–∏—Ä–∏–∫—É—Ç–Ω–∏–∫ + –ü–µ—Ä–∏–º–µ—Ç—Ä + –ü–ª–æ—â—ñ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://unpkg.com/aframe-meshline-component/dist/aframe-meshline-component.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    .panel {
      position: absolute;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 10px;
    }
    #marker-status { top: 10px; left: 10px; width: 260px; }
    #geometry-info { bottom: 10px; left: 10px; width: 260px; }
    #controls {
      top: 10px; right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 10px;
      background: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background: #888;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div id="marker-status" class="panel">
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä A: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä B: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä C: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä D: –Ω–µ –≤–∏–¥–Ω–æ</div>
  </div>

  <div id="geometry-info" class="panel">
    <div>–ü–µ—Ä–∏–º–µ—Ç—Ä: ---</div>
    <div>–ü–ª–æ—â–∞ ABC: ---</div>
    <div>–ü–ª–æ—â–∞ ACD: ---</div>
    <div>–ü–ª–æ—â–∞ BCD: ---</div>
    <div>–ü–ª–æ—â–∞ ABD: ---</div>
  </div>

  <div id="controls" class="panel">
    <button id="start-btn">‚ñ∂Ô∏è –ü–æ—á–∏–Ω–∞—î–º–æ</button>
    <button id="compute-btn" disabled>üìê –û–±—á–∏—Å–ª–∏—Ç–∏</button>
    <button id="clear-btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 4;" 
           vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    
    <a-camera position="0 0 0" look-controls="enabled: false" fov="80"></a-camera>

    <a-entity id="marker-a" mindar-image-target="targetIndex: 0">
      <a-sphere color="red" radius="0.05"></a-sphere>
      <a-text value="A" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-b" mindar-image-target="targetIndex: 1">
      <a-box color="blue" scale="0.1 0.1 0.1"></a-box>
      <a-text value="B" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-c" mindar-image-target="targetIndex: 2">
      <a-dodecahedron color="green" radius="0.07"></a-dodecahedron>
      <a-text value="C" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-d" mindar-image-target="targetIndex: 3">
      <a-cylinder color="purple" radius="0.05" height="0.1"></a-cylinder>
      <a-text value="D" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="logic-node"></a-entity>
  </a-scene>

  <script>
    let log = [];
    let loggingEnabled = false;

    // –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢ –ö–û–ù–í–ï–†–¢–ê–¶–Ü–á!
    // –¶–µ–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–µ–ª–∏–∫–∏—Ö –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –æ–¥–∏–Ω–∏—Ü—å MindAR
    // —É –±—ñ–ª—å—à –∑–≤–∏—á–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º—ñ–ª—ñ–º–µ—Ç—Ä–∏ –∞–±–æ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∏).
    // –ü–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è 30: —è–∫—â–æ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 27000 –º–º, –∞ –æ—á—ñ–∫—É—î—Ç–µ 800 –º–º,
    // —Ç–æ 27000 / 30 = 900 –º–º (–±–ª–∏–∑—å–∫–æ –¥–æ 800 –º–º).
    // –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–π—Ç–µ –∑ —Ü–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º, —â–æ–± –¥–æ—Å—è–≥—Ç–∏ –±–∞–∂–∞–Ω–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ.
    // –Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∏, —Ç–æ finalValue / 10
    const CONVERSION_FACTOR = 30; 

    const logEvent = (...args) => {
      if (loggingEnabled) {
        const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
        log.push(`[${new Date().toISOString()}] ${msg}`);
      }
      console.log(...args);
    };

    function distance(p1, p2) {
      // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –¥–æ –æ–±—á–∏—Å–ª–µ–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ
      return p1.distanceTo(p2) * (1000 / CONVERSION_FACTOR); // –ú–Ω–æ–∂–∏–º–æ –Ω–∞ 1000 –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–µ—Ç—Ä—ñ–≤ –≤ –º–º, –ø–æ—Ç—ñ–º –¥—ñ–ª–∏–º–æ –Ω–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç
    }

    // –§–æ—Ä–º—É–ª–∞ –ì–µ—Ä–æ–Ω–∞ –¥–ª—è –ø–ª–æ—â—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞
    function triangleArea(a, b, c) {
      const s = (a + b + c) / 2;
      const areaSquared = s * (s - a) * (s - b) * (s - c);
      // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ Math.sqrt –≤—ñ–¥ –≤—ñ–¥'—î–º–Ω–∏—Ö —á–∏—Å–µ–ª —á–µ—Ä–µ–∑ –ø–æ—Ö–∏–±–∫–∏ –æ–±—á–∏—Å–ª–µ–Ω—å –∑ –ø–ª–∞–≤–∞—é—á–æ—é —Ç–æ—á–∫–æ—é
      return areaSquared > 0 ? Math.sqrt(areaSquared) : 0;
    }

    AFRAME.registerComponent('logic', {
      init: function () {
        const sceneEl = this.el.sceneEl;
        const markers = {
          a: document.querySelector('#marker-a'),
          b: document.querySelector('#marker-b'),
          c: document.querySelector('#marker-c'),
          d: document.querySelector('#marker-d')
        };

        const statusEls = {
          a: document.querySelector('#marker-status div:nth-child(1)'),
          b: document.querySelector('#marker-status div:nth-child(2)'),
          c: document.querySelector('#marker-status div:nth-child(3)'),
          d: document.querySelector('#marker-status div:nth-child(4)')
        };

        const infoEls = {
          perimeter: document.querySelector('#geometry-info div:nth-child(1)'),
          abc: document.querySelector('#geometry-info div:nth-child(2)'),
          acd: document.querySelector('#geometry-info div:nth-child(3)'),
          bcd: document.querySelector('#geometry-info div:nth-child(4)'),
          abd: document.querySelector('#geometry-info div:nth-child(5)')
        };

        const visibility = { a: false, b: false, c: false, d: false };
        let lineEntities = {}; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –æ–±'—î–∫—Ç–∏ –ª—ñ–Ω—ñ–π

        Object.entries(markers).forEach(([key, marker]) => {
          marker.addEventListener('targetFound', () => {
            visibility[key] = true;
            statusEls[key].textContent = `üü¢ –ú–∞—Ä–∫–µ—Ä ${key.toUpperCase()}: –≤–∏–¥–Ω–æ`;
            checkMarkers();
          });
          marker.addEventListener('targetLost', () => {
            visibility[key] = false;
            statusEls[key].textContent = `üî¥ –ú–∞—Ä–∫–µ—Ä ${key.toUpperCase()}: –Ω–µ –≤–∏–¥–Ω–æ`;
            document.getElementById('compute-btn').disabled = true;
            removeLines(); // –í–∏–¥–∞–ª—è—î–º–æ –ª—ñ–Ω—ñ—ó, —è–∫—â–æ –º–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ
          });
        });

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –≤—Å—ñ –º–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∏–º—ñ, —ñ –æ–Ω–æ–≤–ª—é—î –∫–Ω–æ–ø–∫—É —Ç–∞ –ª—ñ–Ω—ñ—ó
        function checkMarkers() {
          const allVisible = Object.values(visibility).every(Boolean);
          document.getElementById('compute-btn').disabled = !allVisible;
          if (allVisible) {
            drawLines();
          } else {
            removeLines();
          }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ–π –º—ñ–∂ –º–∞—Ä–∫–µ—Ä–∞–º–∏
        function drawLines() {
            removeLines(); // –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ª—ñ–Ω—ñ—ó

            // –û–Ω–æ–≤–ª—é—î–º–æ –º–∞—Ç—Ä–∏—Ü—ñ —Å–≤—ñ—Ç—É –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–≤—ñ—Ç–æ–≤–∏—Ö –ø–æ–∑–∏—Ü—ñ–π
            sceneEl.object3D.updateMatrixWorld(true);

            const pos = {};
            for (let key in markers) {
                pos[key] = markers[key].object3D.getWorldPosition(new THREE.Vector3());
            }

            // –õ–æ–≥—É—î–º–æ —Å–≤—ñ—Ç–æ–≤—ñ –ø–æ–∑–∏—Ü—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤ –¥–ª—è –¥–µ–±–∞–≥—É
            console.log("–ü–æ–∑–∏—Ü—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤ (—Å–≤—ñ—Ç–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏):");
            console.log(`A: ${pos.a.x.toFixed(2)}, ${pos.a.y.toFixed(2)}, ${pos.a.z.toFixed(2)}`);
            console.log(`B: ${pos.b.x.toFixed(2)}, ${pos.b.y.toFixed(2)}, ${pos.b.z.toFixed(2)}`);
            console.log(`C: ${pos.c.x.toFixed(2)}, ${pos.c.y.toFixed(2)}, ${pos.c.z.toFixed(2)}`);
            console.log(`D: ${pos.d.x.toFixed(2)}, ${pos.d.y.toFixed(2)}, ${pos.d.z.toFixed(2)}`);


            const lineColor = '#FF00FF'; // –Ø—Å–∫—Ä–∞–≤–∏–π —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
            // –¢–æ–≤—â–∏–Ω–∞ –ª—ñ–Ω—ñ—ó: 1 –æ–¥–∏–Ω–∏—Ü—è A-Frame = 1 –º–µ—Ç—Ä.
            // –©–æ–± –ª—ñ–Ω—ñ—è –±—É–ª–∞ 10 –º–º —Ç–æ–≤—â–∏–Ω–æ—é, —Ü–µ 0.01 –º–µ—Ç—Ä–∞.
            const lineWidth = 0.01;     

            const createLine = (startPos, endPos, name) => {
                const line = document.createElement('a-entity');
                line.setAttribute('meshline', {
                    path: `${startPos.x} ${startPos.y} ${startPos.z}, ${endPos.x} ${endPos.y} ${endPos.z}`,
                    lineWidth: lineWidth,
                    color: lineColor,
                    depthTest: false, 
                    transparent: true,
                    opacity: 1
                });
                sceneEl.appendChild(line);
                lineEntities[name] = line;
            };

            createLine(pos.a, pos.b, 'ab');
            createLine(pos.b, pos.c, 'bc');
            createLine(pos.c, pos.d, 'cd');
            createLine(pos.d, pos.a, 'da');
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–∏—Ö –ª—ñ–Ω—ñ–π
        function removeLines() {
            for (const key in lineEntities) {
                if (lineEntities[key] && lineEntities[key].parentNode) {
                    lineEntities[key].parentNode.removeChild(lineEntities[key]);
                }
            }
            lineEntities = {}; // –û—á–∏—â–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        }

        document.getElementById('start-btn').addEventListener('click', () => {
          loggingEnabled = true;
          logEvent('‚ñ∂Ô∏è –ü–æ—á–∞—Ç–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è...');
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
          log = [];
          loggingEnabled = false;
          document.getElementById('compute-btn').disabled = true;
          logEvent('üßπ –û—á–∏—â–µ–Ω–æ –ª–æ–≥');
          Object.values(infoEls).forEach(el => el.textContent = el.textContent.split(':')[0] + ': ---');
          removeLines(); // –¢–∞–∫–æ–∂ –≤–∏–¥–∞–ª—è—î–º–æ –ª—ñ–Ω—ñ—ó –ø—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ
        });

        document.getElementById('compute-btn').addEventListener('click', () => {
          logEvent('üìê –û–±—á–∏—Å–ª–µ–Ω–Ω—è...');

          // –û–Ω–æ–≤–ª—é—î–º–æ –º–∞—Ç—Ä–∏—Ü—ñ —Å–≤—ñ—Ç—É –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è–º –ø–æ–∑–∏—Ü—ñ–π –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω—å
          sceneEl.object3D.updateMatrixWorld(true);

          const pos = {};
          for (let key in markers) {
            pos[key] = markers[key].object3D.getWorldPosition(new THREE.Vector3());
          }

          // –û–±—á–∏—Å–ª—é—î–º–æ –≤—ñ–¥—Å—Ç–∞–Ω—ñ, —è–∫—ñ –≤–∂–µ –±—É–¥—É—Ç—å —Å–∫–æ—Ä–∏–≥–æ–≤–∞–Ω—ñ —É —Ñ—É–Ω–∫—Ü—ñ—ó distance()
          const ab = distance(pos.a, pos.b);
          const bc = distance(pos.b, pos.c);
          const cd = distance(pos.c, pos.d);
          const da = distance(pos.d, pos.a);
          const ac = distance(pos.a, pos.c);
          const bd = distance(pos.b, pos.d);

          console.log(`–í—ñ–¥—Å—Ç–∞–Ω—ñ (–ø—ñ—Å–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó): AB=${ab.toFixed(2)}, BC=${bc.toFixed(2)}, CD=${cd.toFixed(2)}, DA=${da.toFixed(2)}, AC=${ac.toFixed(2)}, BD=${bd.toFixed(2)}`);

          const perimeter = ab + bc + cd + da;
          const areaABC = triangleArea(ab, bc, ac);
          const areaACD = triangleArea(ac, cd, da);
          const areaBCD = triangleArea(bc, cd, bd);
          const areaABD = triangleArea(ab, bd, da);

          infoEls.perimeter.textContent = `–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)} –º–º`; 
          infoEls.abc.textContent = `–ü–ª–æ—â–∞ ABC: ${areaABC.toFixed(2)} –º–º¬≤`;
          infoEls.acd.textContent = `–ü–ª–æ—â–∞ ACD: ${areaACD.toFixed(2)} –º–º¬≤`;
          infoEls.bcd.textContent = `–ü–ª–æ—â–∞ BCD: ${areaBCD.toFixed(2)} –º–º¬≤`;
          infoEls.abd.textContent = `–ü–ª–æ—â–∞ ABD: ${areaABD.toFixed(2)} –º–º¬≤`;

          const result = `
–ß–∞—Å: ${new Date().toLocaleString()}
–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)} –º–º
–ü–ª–æ—â–∞ ABC: ${areaABC.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ ACD: ${areaACD.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ BCD: ${areaBCD.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ ABD: ${areaABD.toFixed(2)} –º–º¬≤
`;

          downloadFile('results.txt', result);
          downloadFile('log.txt', log.join('\n'));
        });

        function downloadFile(filename, content) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([content], {type: 'text/plain'}));
          a.download = filename;
          a.click();
        }
      }
    });

    document.querySelector('#logic-node').setAttribute('logic', '');
  </script>
</body>
</html>
