<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR –ß–æ—Ç–∏—Ä–∏–∫—É—Ç–Ω–∏–∫ + –ü–µ—Ä–∏–º–µ—Ç—Ä + –ü–ª–æ—â—ñ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://unpkg.com/aframe-meshline-component/dist/aframe-meshline-component.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    .panel {
      position: absolute;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 10px;
    }
    #marker-status { top: 10px; left: 10px; width: 260px; }
    #geometry-info { bottom: 10px; left: 10px; width: 260px; }
    #controls {
      top: 10px; right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 10px;
      background: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background: #888;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div id="marker-status" class="panel">
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä A: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä B: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä C: –Ω–µ –≤–∏–¥–Ω–æ</div>
    <div>üî¥ –ú–∞—Ä–∫–µ—Ä D: –Ω–µ –≤–∏–¥–Ω–æ</div>
  </div>

  <div id="geometry-info" class="panel">
    <div>–ü–µ—Ä–∏–º–µ—Ç—Ä: ---</div>
    <div>–ü–ª–æ—â–∞ ABC: ---</div>
    <div>–ü–ª–æ—â–∞ ACD: ---</div>
    <div>–ü–ª–æ—â–∞ BCD: ---</div>
    <div>–ü–ª–æ—â–∞ ABD: ---</div>
  </div>

  <div id="controls" class="panel">
    <button id="start-btn">‚ñ∂Ô∏è –ü–æ—á–∏–Ω–∞—î–º–æ</button>
    <button id="compute-btn" disabled>üìê –û–±—á–∏—Å–ª–∏—Ç–∏</button>
    <button id="clear-btn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 4;" 
           vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <a-camera position="0 0 0" look-controls="enabled: false" fov="80"></a-camera>

    <a-entity id="marker-a" mindar-image-target="targetIndex: 0">
      <a-sphere color="red" radius="0.05"></a-sphere>
      <a-text value="A" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-b" mindar-image-target="targetIndex: 1">
      <a-box color="blue" scale="0.1 0.1 0.1"></a-box>
      <a-text value="B" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-c" mindar-image-target="targetIndex: 2">
      <a-dodecahedron color="green" radius="0.07"></a-dodecahedron>
      <a-text value="C" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="marker-d" mindar-image-target="targetIndex: 3">
      <a-cylinder color="purple" radius="0.05" height="0.1"></a-cylinder>
      <a-text value="D" position="0 0.1 0" color="white" scale="0.2 0.2 0.2" align="center"></a-text>
    </a-entity>

    <a-entity id="logic-node"></a-entity>
  </a-scene>

  <script>
    let log = [];
    let loggingEnabled = false;

    const logEvent = (...args) => {
      if (loggingEnabled) {
        const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
        log.push(`[${new Date().toISOString()}] ${msg}`);
      }
      console.log(...args);
    };

    function distance(p1, p2) {
      return p1.distanceTo(p2) * 4 / 100
    }

    function triangleArea(a, b, c) {
      const s = (a + b + c) / 2;
      const areaSquared = s * (s - a) * (s - b) * (s - c);
      return areaSquared > 0 ? Math.sqrt(areaSquared) : 0;
    }

    AFRAME.registerComponent('logic', {
      init: function () {
        const sceneEl = this.el.sceneEl;
        const markers = {
          a: document.querySelector('#marker-a'),
          b: document.querySelector('#marker-b'),
          c: document.querySelector('#marker-c'),
          d: document.querySelector('#marker-d')
        };

        const statusEls = {
          a: document.querySelector('#marker-status div:nth-child(1)'),
          b: document.querySelector('#marker-status div:nth-child(2)'),
          c: document.querySelector('#marker-status div:nth-child(3)'),
          d: document.querySelector('#marker-status div:nth-child(4)')
        };

        const infoEls = {
          perimeter: document.querySelector('#geometry-info div:nth-child(1)'),
          abc: document.querySelector('#geometry-info div:nth-child(2)'),
          acd: document.querySelector('#geometry-info div:nth-child(3)'),
          bcd: document.querySelector('#geometry-info div:nth-child(4)'),
          abd: document.querySelector('#geometry-info div:nth-child(5)')
        };

        const visibility = { a: false, b: false, c: false, d: false };
        let lineEntities = {};

        Object.entries(markers).forEach(([key, marker]) => {
          marker.addEventListener('targetFound', () => {
            visibility[key] = true;
            statusEls[key].textContent = `üü¢ –ú–∞—Ä–∫–µ—Ä ${key.toUpperCase()}: –≤–∏–¥–Ω–æ`;
            checkMarkers();
          });
          marker.addEventListener('targetLost', () => {
            visibility[key] = false;
            statusEls[key].textContent = `üî¥ –ú–∞—Ä–∫–µ—Ä ${key.toUpperCase()}: –Ω–µ –≤–∏–¥–Ω–æ`;
            document.getElementById('compute-btn').disabled = true;
            removeLines();
          });
        });

        function checkMarkers() {
          const allVisible = Object.values(visibility).every(Boolean);
          document.getElementById('compute-btn').disabled = !allVisible;
          if (allVisible) {
            drawLines();
          } else {
            removeLines();
          }
        }

        function drawLines() {
          removeLines();
          sceneEl.object3D.updateMatrixWorld(true);
          const pos = {};
          for (let key in markers) {
            pos[key] = markers[key].object3D.getWorldPosition(new THREE.Vector3());
          }

          const lineColor = '#FF0000'; // —á–µ—Ä–≤–æ–Ω–∏–π
          const lineWidth = 0.01;

          const createLine = (start, end, name) => {
            const line = document.createElement('a-entity');
            const pathStr = `${start.x} ${start.y} ${start.z}, ${end.x} ${end.y} ${end.z}`;
            line.setAttribute('meshline', `path: ${pathStr}; lineWidth: ${lineWidth}; color: ${lineColor}`);
            line.setAttribute('meshline-material', 'depthTest: false; transparent: true; opacity: 1');
            sceneEl.appendChild(line);
            lineEntities[name] = line;
          };

          createLine(pos.a, pos.b, 'ab');
          createLine(pos.b, pos.c, 'bc');
          createLine(pos.c, pos.d, 'cd');
          createLine(pos.d, pos.a, 'da');
        }

        function removeLines() {
          for (const key in lineEntities) {
            if (lineEntities[key] && lineEntities[key].parentNode) {
              lineEntities[key].parentNode.removeChild(lineEntities[key]);
            }
          }
          lineEntities = {};
        }

        document.getElementById('start-btn').addEventListener('click', () => {
          loggingEnabled = true;
          logEvent('‚ñ∂Ô∏è –ü–æ—á–∞—Ç–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è...');
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
          log = [];
          loggingEnabled = false;
          document.getElementById('compute-btn').disabled = true;
          logEvent('üßπ –û—á–∏—â–µ–Ω–æ –ª–æ–≥');
          Object.values(infoEls).forEach(el => el.textContent = el.textContent.split(':')[0] + ': ---');
          removeLines();
        });

        document.getElementById('compute-btn').addEventListener('click', () => {
          logEvent('üìê –û–±—á–∏—Å–ª–µ–Ω–Ω—è...');
          sceneEl.object3D.updateMatrixWorld(true);
          const pos = {};
          for (let key in markers) {
            pos[key] = markers[key].object3D.getWorldPosition(new THREE.Vector3());
          }

          const ab = distance(pos.a, pos.b);
          const bc = distance(pos.b, pos.c);
          const cd = distance(pos.c, pos.d);
          const da = distance(pos.d, pos.a);
          const ac = distance(pos.a, pos.c);
          const bd = distance(pos.b, pos.d);

          const perimeter = ab + bc + cd + da;
          const areaABC = triangleArea(ab, bc, ac);
          const areaACD = triangleArea(ac, cd, da);
          const areaBCD = triangleArea(bc, cd, bd);
          const areaABD = triangleArea(ab, bd, da);

          infoEls.perimeter.textContent = `–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)} –º–º`; 
          infoEls.abc.textContent = `–ü–ª–æ—â–∞ ABC: ${areaABC.toFixed(2)} –º–º¬≤`;
          infoEls.acd.textContent = `–ü–ª–æ—â–∞ ACD: ${areaACD.toFixed(2)} –º–º¬≤`;
          infoEls.bcd.textContent = `–ü–ª–æ—â–∞ BCD: ${areaBCD.toFixed(2)} –º–º¬≤`;
          infoEls.abd.textContent = `–ü–ª–æ—â–∞ ABD: ${areaABD.toFixed(2)} –º–º¬≤`;

          const result = `
–ß–∞—Å: ${new Date().toLocaleString()}
–ü–µ—Ä–∏–º–µ—Ç—Ä: ${perimeter.toFixed(2)} –º–º
–ü–ª–æ—â–∞ ABC: ${areaABC.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ ACD: ${areaACD.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ BCD: ${areaBCD.toFixed(2)} –º–º¬≤
–ü–ª–æ—â–∞ ABD: ${areaABD.toFixed(2)} –º–º¬≤
`;
          downloadFile('results.txt', result);
          downloadFile('log.txt', log.join('\n'));
        });

        function downloadFile(filename, content) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([content], {type: 'text/plain'}));
          a.download = filename;
          a.click();
        }
      }
    });

    document.querySelector('#logic-node').setAttribute('logic', '');
  </script>
</body>
</html>
